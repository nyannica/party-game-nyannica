<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuoRanker - Full Results</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p1: #6366f1; --p2: #ec4899; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #22c55e; --warn: #eab308; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 1rem; min-height: 100vh; margin: 0; }
        .container { max-width: 480px; width: 100%; background: var(--card); padding: 2rem; border-radius: 28px; text-align: center; align-self: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        
        /* Rank List UI */
        #rank-list { list-style: none; padding: 0; margin: 1.5rem 0; }
        .rank-item { background: #334155; margin-bottom: 10px; padding: 1rem; border-radius: 14px; cursor: grab; display: flex; align-items: center; font-size: 0.95rem; border: 2px solid transparent; }
        .rank-item.dragging { opacity: 0.4; border-color: var(--p1); }
        
        /* Result Comparison UI */
        .results-container { margin-top: 20px; text-align: left; }
        .result-row { display: grid; grid-template-columns: 1fr 40px 1fr; gap: 10px; align-items: center; margin-bottom: 8px; background: rgba(15, 23, 42, 0.5); padding: 10px; border-radius: 12px; border-left: 4px solid #475569; }
        .result-row.perfect { border-left-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .result-row.near { border-left-color: var(--warn); }
        
        .res-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .res-val { font-size: 0.85rem; font-weight: 500; }
        .res-arrow { text-align: center; color: #475569; font-weight: bold; }

        /* Buttons */
        button { width: 100%; padding: 1.1rem; border-radius: 14px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: 0.2s; }
        .btn-main { background: var(--p1); color: white; }
        .btn-locked { background: var(--success) !important; color: white; cursor: default; }
        .hidden { display: none; }
        .badge { background: var(--p2); padding: 4px 10px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; margin-bottom: 10px; display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-start">
        <h1>DuoRanker</h1>
        <p style="color: #94a3b8; font-size: 0.9rem;">The ultimate connection game.</p>
        <button class="btn-main" onclick="startHost()">Host Game</button>
        <div style="margin: 20px 0; color: #475569;">— OR —</div>
        <input type="text" id="join-id" placeholder="Enter 4-Digit Code" style="width: 80%; padding: 12px; border-radius: 10px; border: 2px solid #334155; background: #0f172a; color: white; text-align: center; margin-bottom: 10px;">
        <button style="background: #334155; color: white;" onclick="startJoin()">Join Friend</button>
    </div>

    <div id="screen-waiting" class="hidden">
        <h3>Invite Code</h3>
        <div style="font-size: 3rem; font-weight: 800; color: var(--p1); margin: 1rem 0;" id="my-id-display">----</div>
        <p>Waiting for friend...</p>
    </div>

    <div id="screen-game" class="hidden">
        <div id="cat-badge" class="badge">GAME ON</div>
        <h2 id="question-text" style="margin: 0;">...</h2>
        <p id="turn-msg" style="font-size: 0.8rem; color: var(--p1); font-weight: bold; margin: 10px 0;"></p>
        <div id="rank-list"></div>
        <button id="submit-btn" class="btn-main" onclick="sendOrder()">Lock Order</button>
    </div>

    <div id="screen-results" class="hidden">
        <h2 style="margin-bottom: 5px;">Results</h2>
        <div id="score-display" style="font-size: 3.5rem; font-weight: 900; color: var(--p2);">0%</div>
        
        <div class="results-container" id="results-list">
            </div>
        
        <button class="btn-main" onclick="nextRound()">Next Question →</button>
    </div>
</div>

<script>
    // 60 questions bank (shortened for display, but keep your full lists)
    const questionBank = {
        couple: [
            { q: "Favorite Date Night?", opts: ["Fancy Dinner", "Movie Night", "Hiking/Nature", "Concert/Event", "Stay Home & Cook"] },
            { q: "Best Vacation Vibe?", opts: ["Relaxing Beach", "Busy City Trip", "Mountain Cabin", "Theme Parks", "Road Trip"] }
        ],
        personal: [
            { q: "What defines you most?", opts: ["Your Past", "Your Work", "Your Relationships", "Your Dreams", "Your Values"] },
            { q: "Biggest Motivator?", opts: ["Fear of Failure", "Money", "Helping Others", "Recognition", "Personal Growth"] }
        ]
    };

    let peer, conn, myRole, truth, currentQIdx = 0, selectedMode = 'couple', lockedIn = false;

    // --- CONNECTION ---
    function startHost() {
        const rid = Math.floor(1000 + Math.random() * 9000).toString();
        peer = new Peer(rid); myRole = "host";
        peer.on('open', (id) => { document.getElementById('my-id-display').innerText = id; showScreen('screen-waiting'); });
        peer.on('connection', (c) => { conn = c; setupHandlers(); });
    }

    function startJoin() {
        const tid = document.getElementById('join-id').value;
        peer = new Peer(); myRole = "guest";
        peer.on('open', () => { conn = peer.connect(tid); setupHandlers(); });
    }

    function setupHandlers() {
        conn.on('open', () => { showScreen('screen-game'); startRound(); });
        conn.on('data', (data) => {
            if (data.type === 'TRUTH') { truth = data.order; updateTurn(); }
            if (data.type === 'GUESS') { showDetailedResults(truth, data.order); }
            if (data.type === 'NEXT') { currentQIdx++; startRound(); }
        });
    }

    // --- GAME LOGIC ---
    function startRound() {
        showScreen('screen-game');
        truth = null; lockedIn = false;
        const qList = questionBank[selectedMode];
        const q = qList[currentQIdx % qList.length];
        document.getElementById('question-text').innerText = q.q;
        
        const btn = document.getElementById('submit-btn');
        btn.innerText = "Lock My Order"; btn.className = "btn-main";
        
        renderList(q.opts);
        updateTurn();
    }

    function updateTurn() {
        const isHostRound = (currentQIdx % 2 === 0);
        const iAmSetting = (isHostRound && myRole === 'host') || (!isHostRound && myRole === 'guest');
        const msg = document.getElementById('turn-msg');
        const btn = document.getElementById('submit-btn');

        if (lockedIn) {
            msg.innerText = "Waiting for friend...";
            btn.innerText = "✓ Submitted"; btn.className = "btn-locked";
        } else if (iAmSetting) {
            msg.innerText = "RANK YOUR REAL PREFERENCES";
            btn.classList.remove('hidden');
        } else if (!truth) {
            msg.innerText = "WAITING FOR FRIEND TO RANK...";
            btn.classList.add('hidden');
        } else {
            msg.innerText = "GUESS THEIR RANKING!";
            btn.classList.remove('hidden');
        }
    }

    function sendOrder() {
        const order = [...document.querySelectorAll('.rank-item')].map(li => li.innerText);
        lockedIn = true;
        if (!truth) {
            conn.send({ type: 'TRUTH', order: order });
            truth = order;
        } else {
            conn.send({ type: 'GUESS', order: order });
            showDetailedResults(truth, order);
        }
        updateTurn();
    }

    function showDetailedResults(truthArr, guessArr) {
        showScreen('screen-results');
        const listDiv = document.getElementById('results-list');
        listDiv.innerHTML = "";
        
        let pts = 0;
        truthArr.forEach((item, i) => {
            const guessIdx = guessArr.indexOf(item);
            const dist = Math.abs(i - guessIdx);
            
            if (dist === 0) pts += 2;
            else if (dist === 1) pts += 1;

            const row = document.createElement('div');
            row.className = `result-row ${dist === 0 ? 'perfect' : (dist === 1 ? 'near' : '')}`;
            
            row.innerHTML = `
                <div>
                    <span class="res-label">Truth (#${i+1})</span>
                    <span class="res-val">${item}</span>
                </div>
                <div class="res-arrow">vs</div>
                <div>
                    <span class="res-label">Your Guess</span>
                    <span class="res-val">#${guessIdx + 1}</span>
                </div>
            `;
            listDiv.appendChild(row);
        });

        const score = Math.round((pts / (truthArr.length * 2)) * 100);
        document.getElementById('score-display').innerText = score + "%";
    }

    // --- DRAG/DROP & UI ---
    function renderList(opts) {
        const list = document.getElementById('rank-list');
        list.innerHTML = "";
        [...opts].sort(() => Math.random() - 0.5).forEach(text => {
            const li = document.createElement('li');
            li.className = 'rank-item';
            li.draggable = true;
            li.innerText = text;
            li.addEventListener('dragstart', () => { if(!lockedIn) li.classList.add('dragging') });
            li.addEventListener('dragend', () => li.classList.remove('dragging'));
            list.appendChild(li);
        });
    }

    document.getElementById('rank-list').addEventListener('dragover', e => {
        if(lockedIn) return;
        e.preventDefault();
        const dragging = document.querySelector('.dragging');
        const list = document.getElementById('rank-list');
        const afterElement = [...list.querySelectorAll('.rank-item:not(.dragging)')].find(el => {
            return e.clientY <= el.getBoundingClientRect().top + el.getBoundingClientRect().height / 2;
        });
        if (afterElement) list.insertBefore(dragging, afterElement);
        else list.appendChild(dragging);
    });

    function nextRound() {
        currentQIdx++;
        conn.send({ type: 'NEXT' });
        startRound();
    }

    function showScreen(id) {
        ['screen-start', 'screen-waiting', 'screen-game', 'screen-results'].forEach(s => {
            document.getElementById(s).classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
