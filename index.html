<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DuoRanker Multiplayer</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
:root{ --p1:#6366f1; --p2:#ec4899; --bg:#0f172a; --card:#1e293b; --text:#f8fafc; --success:#22c55e; --near:#eab308; }
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);display:flex;justify-content:center;align-items:center;min-height:100vh;padding:1rem;overflow:hidden;}
.container{max-width:480px;width:100%;background:var(--card);padding:1.5rem;border-radius:24px;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto;}
.hidden{display:none !important;}
button{width:100%;padding:1.2rem;border:none;border-radius:12px;font-weight:bold;cursor:pointer;margin-top:8px;transition:0.2s;font-size:1rem;}
.btn-main{background:var(--p1);color:white;}
.btn-main:active{transform:scale(0.95);}
.btn-wait{background:#111827;color:#666;border:1px solid #333;cursor:wait;}
.btn-alt{background:var(--p2);color:white;}
input,select{width:100%;padding:12px;margin-bottom:10px;border-radius:10px;background:#111827;color:white;border:1px solid #333;box-sizing:border-box;font-size:1rem;}
#rank-list{position:relative;margin:1.5rem 0;display:flex;flex-direction:column;gap:10px;}
.rank-item{background:#334155;padding:16px;border-radius:14px;cursor:grab;touch-action:none;text-align:left;user-select:none;display:flex;align-items:center;border:1px solid rgba(255,255,255,0.05);}
.rank-item::before{content:"☰";margin-right:12px;opacity:0.3;}
.rank-item.active{transform:scale(1.05);box-shadow:0 10px 30px rgba(0,0,0,0.5);background:#475569;z-index:100;}
.result-item{display:flex;justify-content:space-between;padding:12px;border-radius:12px;margin-bottom:8px;font-size:0.9rem;}
.result-perfect{border-left:5px solid var(--success);background:rgba(34,197,94,0.15);}
.result-close{border-left:5px solid var(--near);background:rgba(234,179,8,0.15);}
.result-wrong{border-left:5px solid #64748b;background:rgba(100,116,139,0.15);}
.custom-box{background:rgba(0,0,0,0.2); padding:15px; border-radius:15px; margin-top:10px;}
</style>
</head>
<body>
<div class="container">
<div id="status" style="font-size:.7rem;color:var(--near);margin-bottom:10px;opacity:.7;">Connecting...</div>

<div id="screen-start" class="game-screen">
    <h1>DuoRanker</h1>
    <select id="mode-select" onchange="toggleLength()">
        <option value="romance">Romance Mode</option>
        <option value="personal">Personal Mode</option>
        <option value="custom">Custom Creator Mode</option>
    </select>
    <div id="len-wrap">
        <select id="length-select"><option value="10">10 Questions</option><option value="20">20 Questions</option></select>
    </div>
    <button class="btn-main" onclick="startHost()">Host Game</button>
    <div style="margin:15px;color:#475569;font-size:.8rem;">OR</div>
    <input id="join-id" placeholder="Partner's Code" type="tel">
    <button style="background:#334155;color:white;" onclick="startJoin()">Join Game</button>
</div>

<div id="screen-wait" class="game-screen hidden">
    <p>Room Created!</p>
    <h1 id="room-id" style="font-size:3.5rem;color:var(--p1);letter-spacing:4px;">----</h1>
    <p style="opacity:.7;">Waiting for partner...</p>
</div>

<div id="screen-custom-build" class="game-screen hidden">
    <h2>Design Your Question</h2>
    <input id="c-q" placeholder="The Question (e.g. Best Pizza?)">
    <div class="custom-box">
        <input class="c-opt" placeholder="Option 1">
        <input class="c-opt" placeholder="Option 2">
        <input class="c-opt" placeholder="Option 3">
        <input class="c-opt" placeholder="Option 4">
        <input class="c-opt" placeholder="Option 5">
    </div>
    <button class="btn-alt" onclick="submitCustom()">Send to Guesser</button>
</div>

<div id="screen-game" class="game-screen hidden">
    <div id="role" style="font-size:0.75rem;text-transform:uppercase;font-weight:900;letter-spacing:1.5px;margin-bottom:8px;"></div>
    <h2 id="question"></h2>
    <div id="rank-list"></div>
    <button id="submit" class="btn-main" onclick="sendOrder()">Lock My Order</button>
    <p id="round" style="font-size:.7rem;color:#64748b; margin-top:10px;"></p>
</div>

<div id="screen-results" class="game-screen hidden">
    <h2 id="res-score" style="color:var(--p2); margin-bottom:10px;">0% Match</h2>
    <div id="result-list"></div>
    <div id="controls" style="margin-top:20px;"></div>
</div>

<div id="screen-final" class="game-screen hidden">
    <p>Overall Compatibility</p>
    <h1 id="final" style="font-size:6rem;color:var(--p1); margin:0;">0%</h1>
    <button class="btn-main" onclick="location.reload()" style="margin-top:20px;">New Game</button>
</div>
</div>

<script>
// (Bank remains the same as previous version)
const bank={romance:[{q:"Ideal First Date?",opts:["Fine Dining","Quiet Coffee","Gaming Arcade","Sunset Picnic","Movie Night"]}],personal:[{q:"Life Phase?",opts:["Childhood","Teen Years","Young Adult","Established Career","Retirement"]}]};

let peer, conn, role, idx=0, mode="romance", max=10, truth=null, locked=false, total=0, customData=null;

function toggleLength(){
    document.getElementById('len-wrap').classList.toggle('hidden', document.getElementById('mode-select').value === 'custom');
}

function show(screenId){
    document.querySelectorAll(".game-screen").forEach(s => s.classList.add("hidden"));
    document.getElementById(screenId).classList.remove("hidden");
}

function startHost(){
    mode=document.getElementById("mode-select").value;
    max= (mode==='custom') ? 1 : parseInt(document.getElementById("length-select").value);
    peer=new Peer(Math.floor(1000+Math.random()*9000)+"");
    role="host";
    peer.on("open",id=>{ document.getElementById("room-id").innerText=id; show("screen-wait"); });
    peer.on("connection",c=>{conn=c; setupConnection();});
}

function startJoin(){
    peer=new Peer(); role="guest";
    peer.on("open",()=>{
        const id=document.getElementById("join-id").value;
        if(id) { conn=peer.connect(id); setupConnection(); }
    });
}

function setupConnection(){
    conn.on("open",()=>{
        document.getElementById("status").innerText="Online ✔";
        if(role==="guest") conn.send({type:"READY"});
    });
    
    conn.on("data",d=>{
        if(d.type==="READY" && role==="host"){ conn.send({type:"START",mode,max}); startFlow(); }
        if(d.type==="START"){ mode=d.mode; max=d.max; startFlow(); }
        if(d.type==="CUSTOM_DATA"){ customData = d.payload; round(); }
        if(d.type==="TRUTH"){ truth=d.order; ui(); }
        if(d.type==="GUESS"){ reveal(truth, d.order); }
        if(d.type==="NEXT"){ idx = d.i; if(idx >= max) showFinal(); else round(); }
    });
}

function startFlow(){
    if(mode === 'custom'){
        // In custom mode, Host is always the Creator first
        if(role === 'host') show("screen-custom-build");
        else {
            document.getElementById("status").innerText = "Partner is creating...";
            show("screen-game");
            document.getElementById("question").innerText = "Waiting for Custom Question...";
        }
    } else {
        round();
    }
}

function submitCustom(){
    const q = document.getElementById("c-q").value;
    const opts = [...document.querySelectorAll(".c-opt")].map(i => i.value).filter(v => v);
    if(!q || opts.length < 2) return alert("Enter a question and at least 2 options!");
    
    customData = { q, opts };
    conn.send({type: "CUSTOM_DATA", payload: customData});
    round();
}

function round(){
    truth=null; locked=false;
    let qObj;
    if(mode === 'custom'){
        qObj = customData;
    } else {
        const qSet = bank[mode] || bank.romance;
        qObj = qSet[idx % qSet.length];
    }
    document.getElementById("question").innerText = qObj.q;
    document.getElementById("round").innerText = (mode==='custom') ? "Custom Round" : `Question ${idx+1} of ${max}`;
    render(qObj.opts);
    ui();
    show("screen-game");
}

function ui(){
    // In custom mode, the "Truth" setter is always the Creator
    const isCreator = (mode === 'custom') ? (role === 'host') : ((idx%2===0 && role==="host")||(idx%2!==0 && role==="guest"));
    const r=document.getElementById("role"); const b=document.getElementById("submit");
    r.innerText = isCreator ? "Set Your Truth" : (truth ? "Guess Their Truth" : "Partner is Ranking...");
    r.style.color = isCreator ? "var(--p2)" : "var(--p1)";
    b.classList.toggle("hidden", !isCreator && !truth);
    b.disabled = locked;
    b.innerText = locked ? "Order Sent" : "Lock Order";
}

function sendOrder(){
    const order=[...document.querySelectorAll(".rank-item")].map(x=>x.innerText);
    locked=true; ui();
    if(!truth){ truth=order; conn.send({type:"TRUTH",order}); }
    else{ conn.send({type:"GUESS",order}); reveal(truth,order); }
}

function reveal(t,g){
    const list=document.getElementById("result-list"); list.innerHTML="";
    let pts=0;
    t.forEach((x,i)=>{
        const gIdx=g.indexOf(x); const diff=Math.abs(i-gIdx);
        let div=document.createElement("div"); div.className="result-item";
        if(diff===0){ div.classList.add("result-perfect"); pts+=2; }
        else if(diff===1){ div.classList.add("result-close"); pts+=1; }
        else div.classList.add("result-wrong");
        div.innerHTML=`<span>${x}</span><span>Ranked #${gIdx+1}</span>`;
        list.appendChild(div);
    });
    const s=Math.round((pts/(t.length*2))*100); total+=s;
    document.getElementById("res-score").innerText=s+"% Match";
    const ctrl=document.getElementById("controls"); ctrl.innerHTML="";
    if(role==="host"){
        const btn=document.createElement("button"); btn.className="btn-main";
        btn.innerText = (idx+1 >= max) ? "Final Results" : "Next Round →";
        btn.onclick = () => { idx++; conn.send({type:"NEXT", i:idx}); if(idx >= max) showFinal(); else round(); };
        ctrl.appendChild(btn);
    }
    show("screen-results");
}

function showFinal(){ show("screen-final"); document.getElementById("final").innerText=Math.round(total/max)+"%"; }

// Drag Logic (Standard)
let active=null,startY=0;
const rList=document.getElementById("rank-list");
rList.addEventListener("pointerdown",e=>{
    if(locked) return;
    const item=e.target.closest(".rank-item"); if(!item) return;
    active=item; startY=e.clientY - active.getBoundingClientRect().top;
    active.classList.add("active"); active.setPointerCapture(e.pointerId);
});
rList.addEventListener("pointermove",e=>{
    if(!active) return;
    const lRect=rList.getBoundingClientRect();
    const cY=Math.max(0,Math.min(e.clientY-lRect.top-startY, lRect.height-active.offsetHeight));
    active.style.transform=`translateY(${cY-active.offsetTop}px)`;
    const sibs=[...rList.querySelectorAll(".rank-item:not(.active)")];
    const next=sibs.find(s=>e.clientY<=s.getBoundingClientRect().top+s.offsetHeight/2);
    if(next!==active.nextSibling) rList.insertBefore(active,next||null);
});
rList.addEventListener("pointerup",e=>{
    if(!active) return;
    active.classList.remove("active"); active.style.transform=""; active.releasePointerCapture(e.pointerId); active=null;
});

function render(opts){
    rList.innerHTML="";
    [...opts].sort(()=>Math.random()-.5).forEach(t=>{
        const d=document.createElement("div"); d.className="rank-item"; d.innerText=t; rList.appendChild(d);
    });
}
</script>
</body>
</html>
