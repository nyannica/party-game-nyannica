let hostSubmitted = false;
let guestSubmitted = false;

// Update sendOrder()
function sendOrder(){
  const order=[...list.querySelectorAll(".rank-item")].map(x=>x.innerText);
  locked=true; ui();

  if(role==="host"){
    truth=order; 
    hostSubmitted = true;
    conn.send({type:"TRUTH",order});
  } else {
    conn.send({type:"GUESS",order});
    guestSubmitted = true;
  }

  // Only reveal results if both submitted
  if(hostSubmitted && guestSubmitted){
    reveal(truth, order);
    hostSubmitted = guestSubmitted = false; // reset for next round
  }
}

// Update reveal()
function reveal(t,g){
  show("screen-results");
  let pts=0;
  t.forEach((x,i)=>{ const d=Math.abs(i-g.indexOf(x)); if(d===0) pts+=2; else if(d===1) pts+=1; });
  const s=Math.round((pts/10)*100); 
  total += s;
  document.getElementById("score").innerText = s+"%";

  const c=document.getElementById("controls");
  if(role==="host"){
    c.innerHTML = `<button class="btn-main" onclick="next()">${idx+1>=max ? "Final Results" : "Next Round â†’"}</button>`;
  } else {
    c.innerHTML = `<button class="btn-wait" disabled>Waiting for Host...</button>`;
  }
}

// Update NEXT message handling for host & guest
conn.on("data", d=>{
  if(d.type==="NEXT"){
    idx=d.i;
    if(idx>=max) final();
    else round();
  }
  if(d.type==="TRUTH"){truth=d.order; hostSubmitted=true; maybeReveal();}
  if(d.type==="GUESS"){guestSubmitted=true; maybeReveal();}
});

// Helper function
function maybeReveal(){
  if(hostSubmitted && guestSubmitted){
    const order=[...list.querySelectorAll(".rank-item")].map(x=>x.innerText);
    reveal(truth, order);
    hostSubmitted = guestSubmitted = false;
  }
}
